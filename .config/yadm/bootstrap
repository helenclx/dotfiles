#!/usr/bin/env bash

bootstrap_dir="$HOME/.config/yadm/bootstrap.d"

log_bootstrap() {
	local script=$1
	bash "$bootstrap_dir/$script.sh" 2>&1 | tee "$bootstrap_log_dir/$script.log"
}

echo "Creating bootstrap logs directory..."
bootstrap_log_dir="$HOME/yadm-bootstrap-logs"
mkdir -p "$bootstrap_log_dir"

echo "Changing configurations to the one in Helen Chong's yadm repo..."
yadm restore .

echo "Setting up the system locale..."
log_bootstrap "locale"

echo "Installing software for these configuration files..."
echo "Installing packages from Arch Linux's repository..."
log_bootstrap "pacman"

echo "Compiling yay, the AUR helper..."
bash "$bootstrap_dir/yay.sh" >"$bootstrap_log_dir/yay.log"

echo "Installing AUR packages for these config files..."

echo "Installing gpu-screen-recorder and gpu-screen-recorder-ui..."
yay -S gpu-screen-recorder gpu-screen-recorder-ui 2>&1 | tee "$bootstrap_log_dir/gpu-screen-recorder.log"

echo "Installing ElecWhat..."
yay -S elecwhat-bin 2>&1 | tee "$bootstrap_log_dir/elecwhat.log"

echo "Installing additional software from outside Arch Linux's repo and AUR..."
log_bootstrap "extra-software"

echo "Downloading and installing the latest version of Karousel, the script to add scrollable tiling window management to KDE Plasma..."
mkdir -p "$HOME/Downloads" && cd "$HOME/Downloads" || return
curl -s https://api.github.com/repos/peterfajdiga/karousel/releases/latest |
	grep '"tarball_url":' |
	sed -E 's/.*"([^"]+)".*/\1/' |
	xargs curl -L |
	tar -xz -C ~/.local/share/kwin/scripts/
cd "$HOME" || return

echo "Setting up the Catppuccin global theme for KDE Plasma..."
log_bootstrap "catppuccin-kde"

echo "Setting up the Catppuccin theme for tmux..."
log_bootstrap "catppuccin-tmux"

echo "Updating bat's binary cache to apply the Catppuccin Mocha theme..."
bat cache --build

echo "Installing plugins for MPV player..."
log_bootstrap "mpv"

echo "Setting up Neovim..."
log_bootstrap "neovim"

echo "Updating Helen Chong's yadm repo origin URL..."
yadm remote set-url origin "git@git.helenchong.dev:helenchong/dotfiles.git"
echo "Updating Helen Chong's LazyVim configuration repo origin URL..."
cd "$HOME/.config/nvim" || return
git remote set-url origin "git@git.helenchong.dev:helenchong/LazyVim.git"
cd "$HOME" || return

echo "yadm bootstrap program executed. Check out $bootstrap_log_dir for logs."
echo "To complete the setup, select Fcitx 5 as the virtual keyboard in the system settings."
echo "Additionally, it is recommended to enable Karousel in the KWin Scripts settings."
echo "Finally, reboot your system to apply changes."
